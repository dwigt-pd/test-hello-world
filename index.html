<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello, Universe!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <canvas id="starfield"></canvas>

    <!-- Volume control -->
    <div id="vol-control">
        <button id="vol-btn" aria-label="Audio settings" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
        </button>
        <div id="vol-dropdown" role="menu">
            <div class="vol-row">
                <button id="mute-btn" aria-label="Mute audio">
                    <svg id="mute-icon-on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                    </svg>
                    <svg id="mute-icon-off" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true" style="display:none">
                        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                    </svg>
                </button>
                <input type="range" id="vol-slider" min="0" max="1" step="0.01" value="0.7" aria-label="Master volume">
            </div>
            <div class="vol-sep"></div>
            <a href="#" id="attr-link">Sound attributions â†—</a>
        </div>
    </div>

    <!-- Attributions modal -->
    <div id="attr-modal" role="dialog" aria-modal="true" aria-labelledby="attr-heading">
        <div id="attr-modal-inner">
            <button id="attr-close" aria-label="Close">âœ•</button>
            <h2 id="attr-heading">Sound Attributions</h2>
            <ul>
                <li>
                    <span class="attr-title">"Spaceship Engine 1"</span>
                    By <a href="https://freesound.org/people/InSintesi/" target="_blank" rel="noopener">InSintesi</a>
                    via <a href="https://freesound.org/people/InSintesi/sounds/347613/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>
                </li>
                <li>
                    <span class="attr-title">"Spaceship Interface 01"</span>
                    By <a href="https://freesound.org/people/Debsound/" target="_blank" rel="noopener">Debsound</a>
                    via <a href="https://freesound.org/people/Debsound/sounds/251229/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a>
                </li>
                <li>
                    <span class="attr-title">"Key Punch"</span>
                    By <a href="https://freesound.org/people/eben-frostey/" target="_blank" rel="noopener">eben-frostey</a>
                    via <a href="https://freesound.org/people/eben-frostey/sounds/611515/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener">CC0 1.0 (Public Domain)</a>
                </li>
                <li>
                    <span class="attr-title">"Click 02"</span>
                    By <a href="https://freesound.org/people/moogy73/" target="_blank" rel="noopener">moogy73</a>
                    via <a href="https://freesound.org/people/moogy73/sounds/425727/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener">CC0 1.0 (Public Domain)</a>
                </li>
                <li>
                    <span class="attr-title">"Future Alarm 1"</span>
                    By <a href="https://freesound.org/people/Tissman/" target="_blank" rel="noopener">Tissman</a>
                    via <a href="https://freesound.org/people/Tissman/sounds/528659/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener">CC0 1.0 (Public Domain)</a>
                </li>
                <li>
                    <span class="attr-title">"Power Down"</span>
                    By <a href="https://freesound.org/people/DrMrSir/" target="_blank" rel="noopener">DrMrSir</a>
                    via <a href="https://freesound.org/people/DrMrSir/sounds/529558/" target="_blank" rel="noopener">freesound.org</a><br>
                    License: <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>
                </li>
            </ul>
        </div>
    </div>

    <h1 id="title">ðŸš€ Hello, Universe! ðŸš€</h1>
    <img id="plaid-gif" src="https://static.tvtropes.org/pmwiki/pub/images/ludicrous_speed.jpg" alt="Ludicrous speed - we've gone to plaid!" />

    <div id="control-panel" role="group" aria-label="Speed controls">

        <div id="lbl-speed"  class="panel-label"><span>Master Speed<br>Control</span></div>
        <div class="panel-divider"></div>
        <div id="lbl-armed"  class="panel-label"><span>Armed</span></div>
        <div class="panel-divider"></div>
        <div id="lbl-dome"   class="panel-label"><span>Ludicrous<br>Speed</span></div>

        <div id="knob-wrap">
            <div id="knob-container" role="slider" aria-label="Speed dial"
                 aria-valuemin="-135" aria-valuemax="135" aria-valuenow="-45" aria-valuetext="LIGHT"
                 tabindex="0">
                <div id="knob-outer"></div>
                <div id="knob-indicator"></div>
            </div>
            <div id="speed-readout">LIGHT</div>
        </div>

        <div id="go-wrap">
            <div id="go-switch-outer">
                <div id="go-toggle"></div>
            </div>
            <div id="go-label">GO</div>
        </div>

        <button id="dome-btn"
                aria-label="Engage ludicrous speed"
                aria-disabled="true"
                disabled></button>

    </div>

    <script>
        const canvas    = document.getElementById('starfield');
        const ctx       = canvas.getContext('2d');
        const title     = document.getElementById('title');
        const gif       = document.getElementById('plaid-gif');
        const knobEl    = document.getElementById('knob-container');
        const indicator = document.getElementById('knob-indicator');
        const readout   = document.getElementById('speed-readout');
        const goToggle  = document.getElementById('go-toggle');
        const goLabel   = document.getElementById('go-label');
        const domeBtn   = document.getElementById('dome-btn');

        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;

        // â”€â”€ Dial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const DIAL_MIN     = -135;
        const DIAL_MAX     =  135;
        const ARMED_ANGLE  =  115;   // dome button arms above this
        const SPEED_MAX    =   28;
        const SPEED_PLAID  =   90;

        let dialAngle      = -45;      // start roughly at LIGHT
        let dialAnimTarget = null;     // non-null while auto-returning to LIGHT
        let wasArmed       = false;    // tracks armed state for arm-sound trigger
        let plaid          = false;
        let currentSpeed   = 0;
        let tunnelOffset   = 0;

        function angleToSpeed(angle) {
            const t = (angle - DIAL_MIN) / (DIAL_MAX - DIAL_MIN); // 0..1
            return t * t * SPEED_MAX;  // quadratic: gentle at low end, fast at top
        }

        function angleToLabel(angle) {
            if (angle < -80) return 'OFF';
            if (angle <  -5) return 'LIGHT';
            if (angle < ARMED_ANGLE) return 'RIDICULOUS';
            return 'LUDICROUS';
        }

        function setDialAngle(angle) {
            dialAngle = Math.max(DIAL_MIN, Math.min(DIAL_MAX, angle));

            indicator.style.transform = `rotate(${dialAngle}deg)`;
            readout.textContent = angleToLabel(dialAngle);
            knobEl.setAttribute('aria-valuenow',  Math.round(dialAngle));
            knobEl.setAttribute('aria-valuetext', angleToLabel(dialAngle));

            const armed = dialAngle >= ARMED_ANGLE && !plaid;

            if (dialAngle < ARMED_ANGLE && plaid) {
                exitPlaid();
            }

            if (armed && !wasArmed) playArm();
            wasArmed = armed;

            goToggle.classList.toggle('armed', armed);
            goLabel.classList.toggle('armed', armed);

            if (armed) {
                domeBtn.classList.add('armed');
                domeBtn.disabled = false;
                domeBtn.removeAttribute('aria-disabled');
            } else if (!plaid) {
                domeBtn.classList.remove('armed');
                domeBtn.disabled = true;
                domeBtn.setAttribute('aria-disabled', 'true');
            }
        }

        function enterPlaid() {
            plaid = true;
            domeBtn.classList.remove('armed');
            domeBtn.classList.add('active');
            domeBtn.setAttribute('aria-label', 'Disengage ludicrous speed');
            title.textContent = 'Ahhhhhh!!!!!';
            title.classList.add('ludicrous-active');
            gif.style.display = 'block';
            playLudicrous();
            startAlarm();
        }

        function exitPlaid() {
            plaid          = false;
            dialAnimTarget = -45;  // gradual return to LIGHT
            domeBtn.classList.remove('active');
            domeBtn.setAttribute('aria-label', 'Engage ludicrous speed');
            gif.style.display   = 'none';
            stopAlarm();
            playDisarm();
            wasArmed            = false;
            title.textContent   = 'ðŸš€ Hello, Universe! ðŸš€';
            title.classList.remove('ludicrous-active');
            const armed = dialAngle >= ARMED_ANGLE;
            goToggle.classList.toggle('armed', armed);
            goLabel.classList.toggle('armed', armed);
            if (armed) {
                domeBtn.classList.add('armed');
                domeBtn.disabled = false;
                domeBtn.removeAttribute('aria-disabled');
            }
        }

        // â”€â”€ Knob drag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let dragging         = false;
        let lastPointerAngle = 0;
        let clickAccum       = 0;         // accumulated rotation for click detents
        const CLICK_STEP     = 20;        // degrees per click

        function knobCenterAngle(clientX, clientY) {
            const rect = knobEl.getBoundingClientRect();
            const cx = rect.left + rect.width  / 2;
            const cy = rect.top  + rect.height / 2;
            return Math.atan2(clientY - cy, clientX - cx);
        }

        function applyKnobDelta(newAngle) {
            let delta = newAngle - lastPointerAngle;
            // Normalise wrap-around so dragging past 180Â° doesn't jump
            if (delta >  Math.PI) delta -= Math.PI * 2;
            if (delta < -Math.PI) delta += Math.PI * 2;
            lastPointerAngle = newAngle;
            const degrees = delta * (180 / Math.PI);
            setDialAngle(dialAngle + degrees);
            clickAccum += Math.abs(degrees);
            while (clickAccum >= CLICK_STEP) {
                clickAccum -= CLICK_STEP;
                playClick();
            }
        }

        knobEl.addEventListener('mousedown', e => {
            dragging         = true;
            dialAnimTarget   = null;   // cancel auto-return if user grabs knob
            lastPointerAngle = knobCenterAngle(e.clientX, e.clientY);
            e.preventDefault();
        });
        window.addEventListener('mousemove', e => {
            if (!dragging) return;
            applyKnobDelta(knobCenterAngle(e.clientX, e.clientY));
        });
        window.addEventListener('mouseup', () => { dragging = false; });

        knobEl.addEventListener('touchstart', e => {
            dragging         = true;
            dialAnimTarget   = null;   // cancel auto-return if user grabs knob
            lastPointerAngle = knobCenterAngle(e.touches[0].clientX, e.touches[0].clientY);
            e.preventDefault();
        }, { passive: false });
        window.addEventListener('touchmove', e => {
            if (!dragging) return;
            applyKnobDelta(knobCenterAngle(e.touches[0].clientX, e.touches[0].clientY));
        }, { passive: false });
        window.addEventListener('touchend', () => { dragging = false; });

        knobEl.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp'   || e.key === 'ArrowRight') { setDialAngle(dialAngle + 8);  e.preventDefault(); }
            if (e.key === 'ArrowDown' || e.key === 'ArrowLeft')  { setDialAngle(dialAngle - 8); e.preventDefault(); }
        });

        // â”€â”€ Dome button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        domeBtn.addEventListener('click', () => {
            if (plaid)                      exitPlaid();
            else if (dialAngle >= ARMED_ANGLE) enterPlaid();
        });

        // â”€â”€ Starfield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const NUM_STARS = 500;

        function newStar(spreadOut = false) {
            return {
                angle:        Math.random() * Math.PI * 2,
                dist:         spreadOut ? Math.random() * 0.8 : 0.01,
                hue:          Math.random() * 360,
                flickerPhase: Math.random() * Math.PI * 2,
                flickerSpeed: 0.025 + Math.random() * 0.04,
            };
        }

        const stars = Array.from({ length: NUM_STARS }, () => newStar(true));

        function drawTunnel(cx, cy) {
            tunnelOffset += 0.028;

            const numRings = 18;
            const maxW = canvas.width  * 0.92;
            const maxH = canvas.height * 0.92;

            // Perspective lines: 4 corners + 4 cardinal edges
            ctx.lineWidth   = 1.5;
            ctx.strokeStyle = 'rgba(255, 120, 0, 0.55)';
            for (const [sx, sy] of [[-1,-1],[1,-1],[1,1],[-1,1],[0,-1],[1,0],[0,1],[-1,0]]) {
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(cx + sx * maxW / 2, cy + sy * maxH / 2);
                ctx.stroke();
            }

            for (let i = 0; i < numRings; i++) {
                const t     = ((i / numRings) + tunnelOffset) % 1;
                const scale = t;
                if (scale < 0.02) continue;
                const w     = maxW * scale;
                const h     = maxH * scale;
                const alpha = Math.min(1, t * 2) * 0.85;
                const green = Math.floor(60 + t * 80);
                ctx.strokeStyle = `rgba(255, ${green}, 0, ${alpha})`;
                ctx.lineWidth   = 1 + t * 3;
                ctx.strokeRect(cx - w / 2, cy - h / 2, w, h);
            }

            // Large warm radial glow â€” proportional to viewport
            const glowR = Math.min(cx, cy) * 0.65;
            const glow  = ctx.createRadialGradient(cx, cy, 0, cx, cy, glowR);
            glow.addColorStop(0,    'rgba(255, 255, 220, 1)');
            glow.addColorStop(0.07, 'rgba(255, 230, 100, 0.95)');
            glow.addColorStop(0.22, 'rgba(255, 140, 20,  0.75)');
            glow.addColorStop(0.5,  'rgba(255, 55,  0,   0.3)');
            glow.addColorStop(1,    'rgba(0,   0,   0,   0)');
            ctx.fillStyle = glow;
            ctx.beginPath();
            ctx.arc(cx, cy, glowR, 0, Math.PI * 2);
            ctx.fill();
        }

        function draw() {
            const cx      = canvas.width  / 2;
            const cy      = canvas.height / 2;
            const maxDist = Math.sqrt(cx * cx + cy * cy);

            // Gradually return dial to LIGHT after exiting plaid
            if (dialAnimTarget !== null) {
                const next = dialAngle + (dialAnimTarget - dialAngle) * 0.04;
                if (Math.abs(next - dialAnimTarget) < 0.5) {
                    setDialAngle(dialAnimTarget);
                    dialAnimTarget = null;
                } else {
                    setDialAngle(next);
                }
            }

            const targetSpeed = plaid ? SPEED_PLAID : angleToSpeed(dialAngle);
            currentSpeed += (targetSpeed - currentSpeed) * 0.08;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 0 = pure flickering dots, 1 = pure streaks
            const streakBlend = Math.min(1, currentSpeed / 3);

            for (const star of stars) {
                const prevDist = star.dist;
                star.dist += (currentSpeed / 1000) * (1 + star.dist * 3);

                const x  = cx + Math.cos(star.angle) * star.dist  * maxDist;
                const y  = cy + Math.sin(star.angle) * star.dist  * maxDist;
                const px = cx + Math.cos(star.angle) * prevDist   * maxDist;
                const py = cy + Math.sin(star.angle) * prevDist   * maxDist;

                const radius      = Math.max(0.8, star.dist * 2.2);
                const baseOpacity = Math.min(1, 0.25 + star.dist * 1.2);

                star.flickerPhase = (star.flickerPhase + star.flickerSpeed) % (Math.PI * 2);
                const flicker = 0.35 + 0.65 * Math.abs(Math.sin(star.flickerPhase));

                if (plaid) {
                    star.hue = (star.hue + 1.5) % 360;

                    ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y);
                    ctx.strokeStyle = `hsla(${star.hue}, 100%, 60%, ${baseOpacity * 0.3})`;
                    ctx.lineWidth   = radius * 5;
                    ctx.stroke();

                    ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y);
                    ctx.strokeStyle = `hsla(${star.hue}, 100%, 82%, ${baseOpacity})`;
                    ctx.lineWidth   = radius;
                    ctx.stroke();
                } else {
                    // Flickering dot â€” fades out as streaks take over
                    if (streakBlend < 0.99) {
                        ctx.fillStyle = `rgba(255, 255, 255, ${baseOpacity * flicker * (1 - streakBlend)})`;
                        ctx.beginPath();
                        ctx.arc(x, y, Math.max(1.5, radius * 0.9), 0, Math.PI * 2);
                        ctx.fill();
                    }
                    // Streak â€” fades in as speed rises
                    if (streakBlend > 0.01) {
                        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${baseOpacity * streakBlend})`;
                        ctx.lineWidth   = radius;
                        ctx.stroke();
                    }
                }

                if (x < 0 || x > canvas.width || y < 0 || y > canvas.height) {
                    Object.assign(star, newStar());
                }
            }

            if (plaid) drawTunnel(cx, cy);
            updateAudio();
            requestAnimationFrame(draw);
        }

        // â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const audioCtx   = new (window.AudioContext || window.webkitAudioContext)();
        let engineGain    = null;
        let engineSrc     = null;
        let ludicrousBuf  = null;
        let armBuf        = null;
        let alarmBuf      = null;
        let clickBuf      = null;
        let disarmBuf     = null;
        let alarmSrc      = null;
        let alarmGain     = null;
        let audioReady    = false;
        let masterVol     = 0.7;

        async function initAudio() {
            await audioCtx.resume();
            if (audioReady) return;

            const [engineRaw, ludicrousRaw, armRaw, alarmRaw, clickRaw, disarmRaw] = await Promise.all([
                fetch('audio/347613__insintesi__spaceship-engine-1.wav').then(r => r.arrayBuffer()),
                fetch('audio/251229__debsound__spaceship-interface-01.wav').then(r => r.arrayBuffer()),
                fetch('audio/611515__eben-frostey__key-punch.mp3').then(r => r.arrayBuffer()),
                fetch('audio/528659__tissman__future-alarm-1.wav').then(r => r.arrayBuffer()),
                fetch('audio/425727__moogy73__click02.wav').then(r => r.arrayBuffer()),
                fetch('audio/529558__drmrsir__power-down.wav').then(r => r.arrayBuffer()),
            ]);

            const [engineDecoded, ludicrousDecoded, armDecoded, alarmDecoded, clickDecoded, disarmDecoded] = await Promise.all([
                audioCtx.decodeAudioData(engineRaw),
                audioCtx.decodeAudioData(ludicrousRaw),
                audioCtx.decodeAudioData(armRaw),
                audioCtx.decodeAudioData(alarmRaw),
                audioCtx.decodeAudioData(clickRaw),
                audioCtx.decodeAudioData(disarmRaw),
            ]);

            engineGain            = audioCtx.createGain();
            engineGain.gain.value = 0;
            engineGain.connect(audioCtx.destination);

            engineSrc        = audioCtx.createBufferSource();
            engineSrc.buffer = engineDecoded;
            engineSrc.loop   = true;
            engineSrc.connect(engineGain);
            engineSrc.start();

            ludicrousBuf = ludicrousDecoded;
            armBuf       = armDecoded;
            alarmBuf     = alarmDecoded;
            clickBuf     = clickDecoded;
            disarmBuf    = disarmDecoded;

            alarmGain            = audioCtx.createGain();
            alarmGain.gain.value = 0;
            alarmGain.connect(audioCtx.destination);

            audioReady = true;
        }

        function playClick() {
            if (!clickBuf) return;
            const gain      = audioCtx.createGain();
            gain.gain.value = masterVol * 0.2;
            gain.connect(audioCtx.destination);
            const src  = audioCtx.createBufferSource();
            src.buffer = clickBuf;
            src.connect(gain);
            src.start();
        }

        function playArm() {
            if (!armBuf) return;
            const gain      = audioCtx.createGain();
            gain.gain.value = masterVol;
            gain.connect(audioCtx.destination);
            const src  = audioCtx.createBufferSource();
            src.buffer = armBuf;
            src.connect(gain);
            src.start();
        }

        function playDisarm() {
            if (!disarmBuf) return;
            const gain      = audioCtx.createGain();
            gain.gain.value = masterVol * 0.5;
            gain.connect(audioCtx.destination);
            const src  = audioCtx.createBufferSource();
            src.buffer = disarmBuf;
            src.connect(gain);
            src.start();
        }

        function startAlarm() {
            if (!alarmBuf || !alarmGain) return;
            alarmSrc        = audioCtx.createBufferSource();
            alarmSrc.buffer = alarmBuf;
            alarmSrc.loop   = true;
            alarmSrc.connect(alarmGain);
            alarmSrc.start();
            alarmGain.gain.setTargetAtTime(masterVol, audioCtx.currentTime, 0.3);
        }

        function stopAlarm() {
            if (!alarmSrc || !alarmGain) return;
            alarmGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.3);
            const src = alarmSrc;
            alarmSrc  = null;
            setTimeout(() => { try { src.stop(); } catch(_) {} }, 1000);
        }

        function playLudicrous() {
            if (!ludicrousBuf) return;
            const gain  = audioCtx.createGain();
            gain.gain.value = masterVol;
            gain.connect(audioCtx.destination);
            const src   = audioCtx.createBufferSource();
            src.buffer  = ludicrousBuf;
            src.connect(gain);
            src.start();
        }

        function updateAudio() {
            if (!audioReady) return;
            const t = Math.min(1, currentSpeed / SPEED_PLAID);
            engineGain.gain.value        = masterVol * (0.75 + t * 0.25);
            engineSrc.playbackRate.value = 0.5 + t * 1.0;
        }

        // Start audio on first user gesture (browser autoplay policy)
        function onFirstGesture() {
            initAudio();
            document.removeEventListener('mousedown',  onFirstGesture);
            document.removeEventListener('click',      onFirstGesture);
            document.removeEventListener('keydown',    onFirstGesture);
            document.removeEventListener('touchstart', onFirstGesture);
        }
        document.addEventListener('mousedown',  onFirstGesture);
        document.addEventListener('click',      onFirstGesture);
        document.addEventListener('keydown',    onFirstGesture);
        document.addEventListener('touchstart', onFirstGesture);

        // â”€â”€ Volume dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const volBtn      = document.getElementById('vol-btn');
        const volDropdown = document.getElementById('vol-dropdown');
        const volSlider   = document.getElementById('vol-slider');
        const muteBtn     = document.getElementById('mute-btn');
        const muteIconOn  = document.getElementById('mute-icon-on');
        const muteIconOff = document.getElementById('mute-icon-off');
        const attrLink    = document.getElementById('attr-link');
        const attrModal   = document.getElementById('attr-modal');
        const attrClose   = document.getElementById('attr-close');

        let muted         = false;
        let preMuteVol    = masterVol;

        volBtn.addEventListener('click', e => {
            e.stopPropagation();
            const open = volDropdown.classList.toggle('open');
            volBtn.setAttribute('aria-expanded', open);
        });

        volSlider.addEventListener('input', () => {
            masterVol = parseFloat(volSlider.value);
            if (muted && masterVol > 0) {
                muted = false;
                muteBtn.classList.remove('muted');
                muteBtn.setAttribute('aria-label', 'Mute audio');
                muteIconOn.style.display  = '';
                muteIconOff.style.display = 'none';
            }
        });

        muteBtn.addEventListener('click', e => {
            e.stopPropagation();
            muted = !muted;
            if (muted) {
                preMuteVol = masterVol;
                masterVol  = 0;
                volSlider.value = 0;
                muteBtn.classList.add('muted');
                muteBtn.setAttribute('aria-label', 'Unmute audio');
                muteIconOn.style.display  = 'none';
                muteIconOff.style.display = '';
            } else {
                masterVol = preMuteVol || 0.7;
                volSlider.value = masterVol;
                muteBtn.classList.remove('muted');
                muteBtn.setAttribute('aria-label', 'Mute audio');
                muteIconOn.style.display  = '';
                muteIconOff.style.display = 'none';
            }
        });

        document.addEventListener('click', e => {
            if (!volDropdown.contains(e.target) && e.target !== volBtn) {
                volDropdown.classList.remove('open');
                volBtn.setAttribute('aria-expanded', 'false');
            }
        });

        attrLink.addEventListener('click', e => {
            e.preventDefault();
            volDropdown.classList.remove('open');
            volBtn.setAttribute('aria-expanded', 'false');
            attrModal.classList.add('open');
        });

        function closeAttrModal() { attrModal.classList.remove('open'); }
        attrClose.addEventListener('click', closeAttrModal);
        attrModal.addEventListener('click', e => {
            if (e.target === attrModal) closeAttrModal();
        });
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeAttrModal();
        });

        // â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setDialAngle(-45);
        draw();

        window.addEventListener('resize', () => {
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
